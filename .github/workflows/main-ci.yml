name: Main CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: false
        default: 'auto'
        type: choice
        options:
        - auto
        - development
        - production

env:
  CARGO_TERM_COLOR: always
  APPWRITE_DATABASE_ID: intrada_db
  APPWRITE_DATABASE_NAME: "Intrada Database"

# Prevent concurrent runs on the same branch/PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # Job to determine what changed and what needs to be built
  changes:
    runs-on: ubuntu-latest
    outputs:
      rust: ${{ steps.changes.outputs.rust }}
      ios: ${{ steps.changes.outputs.ios }}
      web: ${{ steps.changes.outputs.web }}
      appwrite: ${{ steps.changes.outputs.appwrite }}
      crux: ${{ steps.changes.outputs.crux }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for changes
        uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            rust:
              - 'shared/**'
              - 'infrastructure/**'
              - 'Cargo.toml'
              - 'Cargo.lock'
              - 'rust-toolchain.toml'
            ios:
              - 'iOS/**'
              - 'shared/**'
              - '.github/workflows/main-ci.yml'
            web:
              - 'web-leptos/**'
              - 'shared/**'
              - '.github/workflows/main-ci.yml'
            appwrite:
              - 'infrastructure/**'
              - 'appwrite.json'
              - 'scripts/setup-appwrite-complete.sh'
            crux:
              - 'scripts/setup-crux.sh'
              - '.github/scripts/detect-environment.sh'
              - 'Cargo.toml'
              - 'shared/Cargo.toml'

  # Pre-compile Rust dependencies for reuse across jobs
  compile-deps:
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.rust == 'true' || needs.changes.outputs.web == 'true' || needs.changes.outputs.appwrite == 'true'
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Crux dependency
        if: needs.changes.outputs.crux == 'true'
        run: |
          ./scripts/setup-crux.sh
        env:
          CI: true
          CRUX_REPO: "redbadger/crux"
          CRUX_REF: "main"
          CRUX_PATH: "../crux"
          
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown
          components: clippy, rustfmt
          
      - name: Generate cache key
        id: cache-key
        run: |
          key="deps-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}-v3"
          echo "key=$key" >> $GITHUB_OUTPUT
          
      - name: Cache Rust dependencies
        uses: actions/cache@v4
        id: cache-deps
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target/debug/deps
            target/debug/build
            target/wasm32-unknown-unknown/debug/deps
            target/wasm32-unknown-unknown/debug/build
            shared/target/debug/deps
            shared/target/debug/build
            web-leptos/target/debug/deps
            web-leptos/target/debug/build
            web-leptos/target/wasm32-unknown-unknown/debug/deps
            web-leptos/target/wasm32-unknown-unknown/debug/build
            infrastructure/target/debug/deps
            infrastructure/target/debug/build
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: |
            deps-${{ runner.os }}-v3
            
      - name: Pre-compile dependencies
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: |
          # Pre-compile workspace dependencies (host target)
          cargo fetch --locked
          cargo build --workspace --lib --bins --no-default-features
          
          # Pre-compile web dependencies (WASM target)
          cd web-leptos
          cargo fetch --locked
          cargo build --target wasm32-unknown-unknown --lib --no-default-features
          
          # Pre-compile infrastructure dependencies
          cd ../infrastructure
          cargo fetch --locked
          cargo build --lib --no-default-features
          
          # Pre-compile shared dependencies
          cd ../shared
          cargo fetch --locked
          cargo build --lib --no-default-features
          cargo build --target wasm32-unknown-unknown --lib --no-default-features

  # Basic Rust checks (formatting, clippy, tests)
  rust-checks:
    runs-on: ubuntu-latest
    needs: [changes, compile-deps]
    if: needs.changes.outputs.rust == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Crux dependency
        if: needs.changes.outputs.crux == 'true'
        run: |
          ./scripts/setup-crux.sh
        env:
          CI: true
          CRUX_REPO: "redbadger/crux"
          CRUX_REF: "main"
          CRUX_PATH: "../crux"
          
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt
          
      - name: Restore Rust dependencies cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target/debug/deps
            target/debug/build
            shared/target/debug/deps
            shared/target/debug/build
            infrastructure/target/debug/deps
            infrastructure/target/debug/build
          key: ${{ needs.compile-deps.outputs.cache-key }}
          restore-keys: |
            deps-${{ runner.os }}-v3
            
      - name: Check code formatting
        run: cargo fmt --all -- --check
        
      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings
        
      - name: Run tests
        run: |
          cargo test --workspace
          cd infrastructure && cargo test --features cli

  # Pre-compile iOS dependencies
  compile-ios-deps:
    runs-on: macos-14
    needs: changes
    if: needs.changes.outputs.ios == 'true'
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Crux dependency
        if: needs.changes.outputs.crux == 'true'
        run: |
          ./scripts/setup-crux.sh
        env:
          CI: true
          CRUX_REPO: "redbadger/crux"
          CRUX_REF: "main"
          CRUX_PATH: "../crux"
          
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios-sim,x86_64-apple-ios
          
      - name: Generate cache key
        id: cache-key
        run: |
          key="ios-deps-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}-v3"
          echo "key=$key" >> $GITHUB_OUTPUT
          
      - name: Cache iOS Rust dependencies
        uses: actions/cache@v4
        id: cache-ios-deps
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            shared/target/aarch64-apple-ios-sim/debug/deps
            shared/target/aarch64-apple-ios-sim/debug/build
            shared/target/x86_64-apple-ios/debug/deps
            shared/target/x86_64-apple-ios/debug/build
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: |
            ios-deps-${{ runner.os }}-v3
            
      - name: Install cargo-lipo
        if: steps.cache-ios-deps.outputs.cache-hit != 'true'
        run: |
          if ! command -v cargo-lipo &> /dev/null; then
            cargo install cargo-lipo
          fi

      - name: Install cargo-swift
        if: steps.cache-ios-deps.outputs.cache-hit != 'true'
        run: |
          if ! command -v cargo-swift &> /dev/null; then
            cargo install cargo-swift
          fi
          
      - name: Pre-compile iOS dependencies
        if: steps.cache-ios-deps.outputs.cache-hit != 'true'
        run: |
          cd shared
          cargo fetch --locked
          # Pre-compile dependencies for iOS targets
          cargo build --target aarch64-apple-ios-sim --lib --no-default-features
          cargo build --target x86_64-apple-ios --lib --no-default-features

  # iOS build and test
  ios-build:
    runs-on: macos-14
    needs: [changes, compile-ios-deps]
    if: needs.changes.outputs.ios == 'true'
    env:
      DEVELOPER_DIR: /Applications/Xcode_15.2.app/Contents/Developer
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Crux dependency
        if: needs.changes.outputs.crux == 'true'
        run: |
          ./scripts/setup-crux.sh
        env:
          CI: true
          CRUX_REPO: "redbadger/crux"
          CRUX_REF: "main"
          CRUX_PATH: "../crux"

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.2'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios-sim,x86_64-apple-ios

      - name: Restore iOS Rust dependencies cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            shared/target/aarch64-apple-ios-sim/debug/deps
            shared/target/aarch64-apple-ios-sim/debug/build
            shared/target/x86_64-apple-ios/debug/deps
            shared/target/x86_64-apple-ios/debug/build
          key: ${{ needs.compile-ios-deps.outputs.cache-key }}
          restore-keys: |
            ios-deps-${{ runner.os }}-v3

      - name: Install cargo-lipo
        run: |
          if ! command -v cargo-lipo &> /dev/null; then
            cargo install cargo-lipo
          fi

      - name: Install uniffi-bindgen
        run: |
          if ! command -v uniffi-bindgen &> /dev/null; then
            cargo install uniffi --version 0.29.3 --features cli
          fi

      - name: Install cargo-swift
        run: |
          if ! command -v cargo-swift &> /dev/null; then
            cargo install cargo-swift
          fi

      - name: Generate Swift types and bindings
        run: |
          ./typegen.sh
          
      - name: Build iOS app
        run: |
          cd shared
          cargo lipo --release --targets aarch64-apple-ios-sim,x86_64-apple-ios
          mkdir -p ../iOS/Generated/
          uniffi-bindgen generate src/shared.udl --language swift --out-dir ../iOS/Generated/
          
          cd ../iOS
          xcodebuild \
            -project Intrada.xcodeproj \
            -scheme Intrada \
            -configuration Debug \
            -destination 'platform=iOS Simulator,name=iPhone 15 Pro,OS=latest' \
            clean build \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

  # Web build and test
  web-build:
    runs-on: ubuntu-latest
    needs: [changes, compile-deps]
    if: needs.changes.outputs.web == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Crux dependency
        if: needs.changes.outputs.crux == 'true'
        run: |
          ./scripts/setup-crux.sh
        env:
          CI: true
          CRUX_REPO: "redbadger/crux"
          CRUX_REF: "main"
          CRUX_PATH: "../crux"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Restore Rust dependencies cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target/wasm32-unknown-unknown/debug/deps
            target/wasm32-unknown-unknown/debug/build
            web-leptos/target/debug/deps
            web-leptos/target/debug/build
            web-leptos/target/wasm32-unknown-unknown/debug/deps
            web-leptos/target/wasm32-unknown-unknown/debug/build
            shared/target/debug/deps
            shared/target/debug/build
          key: ${{ needs.compile-deps.outputs.cache-key }}
          restore-keys: |
            deps-${{ runner.os }}-v3

      - name: Install Trunk
        run: cargo install trunk --force

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "web-leptos/package-lock.json"

      - name: Install NPM dependencies
        run: npm ci
        working-directory: ./web-leptos

      - name: Build web app
        run: |
          cd web-leptos
          npm run build
          
      - name: Upload dist artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: ./web-leptos/dist
          retention-days: 1

  # Appwrite deployment
  appwrite-deploy:
    runs-on: ubuntu-latest
    needs: [changes, rust-checks, compile-deps]
    if: needs.changes.outputs.appwrite == 'true' && github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Crux dependency
        if: needs.changes.outputs.crux == 'true'
        run: |
          ./scripts/setup-crux.sh
        env:
          CI: true
          CRUX_REPO: "redbadger/crux"
          CRUX_REF: "main"
          CRUX_PATH: "../crux"
          
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        
      - name: Restore Rust dependencies cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target/debug/deps
            target/debug/build
            infrastructure/target/debug/deps
            infrastructure/target/debug/build
            shared/target/debug/deps
            shared/target/debug/build
          key: ${{ needs.compile-deps.outputs.cache-key }}
          restore-keys: |
            deps-${{ runner.os }}-v3
            
      - name: Build CLI tool
        run: |
          cd infrastructure
          cargo build --bin appwrite_cli --features cli --release
          
      - name: Deploy to development
        if: github.ref != 'refs/heads/main'
        run: |
          # Setup local Appwrite for development
          docker compose up -d
          timeout 120 bash -c 'until curl -s http://localhost/v1/health > /dev/null 2>&1; do sleep 2; done'
          
          cd infrastructure
          ../target/release/appwrite_cli deploy \
            --database-id $APPWRITE_DATABASE_ID \
            --database-name "$APPWRITE_DATABASE_NAME" \
            --environment development

  # Vercel deployment (only for main branch)
  vercel-deploy:
    runs-on: ubuntu-latest
    needs: [changes, web-build]
    if: needs.changes.outputs.web == 'true' && github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment: production
    env:
      VERCEL_ORG_ID: ${{ secrets.ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.PROJECT_ID }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download dist artifact
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: ./web-leptos/dist

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Deploy to Vercel
        run: |
          vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
          vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
          vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }} 